# M1. MLOps 개념

## 1.0 MLOps 다시 알아보기

### MLOps 정의하기

- **ML + DevOps = MLOps**
- DevOps
	- 소프트웨어 개발 및 운영 생산성을 높이기 위한 방법론
	- 소프트웨어 개발과 인프라 관리 과정에서 전통적인 방식을 사용하는 조직에 비해 제품을 더 빠르게 진화 및 개선시키는 것을 목표로 하는 개발 문화
- MLOps
	- ML 모델의 프로덕션 배포와 유지 관리를 자동화하기 위한 방법론
	- ML 모델의 생산, 배포, 유지 보수를 자동화하고 개선하는 것을 목표로 하는 개발 문화
- 요악하자면 MLOps는 ML 모델의 배포와 유지보수를 자동화하고 개선하기 위한 **방법론이면서 개발 문화**

### DevOps와 MLOps의 간단한 비교


|                                | DevOps                                                              | MLOps                                                                 |
| ------------------------------ | ------------------------------------------------------------------- | --------------------------------------------------------------------- |
| 📜 정의                        | 소프트웨어 개발자 간의 소통과 협업을 강조하는 개발 문화             | DS와 엔지니어 간의 소통과 협업을 강조하는 ML 엔지니어링 문화          |
| 🔗 CI (Continuous Integration) | 개발자를 위한 자동화 프로세스인 지속적인 통합 (코드 충돌 문제 해결) | 데이터, 데이터 스키마, 모델에 대해 테스트하고 검증을 추가로 수행      |
| 📦 CD (Continuous Deployment)  | 지속적인 서비스 제공 및 지속적인 배포                               | 모델 학습 및 예측 서비스를 자동으로 배포하는 시스템                   |
| 🧑‍🎓 CT (Continuous Training)    | 없음                                                                | ML 시스템만의 고유 속성으로 모델을 자동으로 재학습 시키고 서비스 제공 |

## 1.1 MLOps 프로세스 살펴보기

### MLOps 수준별 비교

Reference : https://cloud.google.com/architecture/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning

#### MLOps Level 0 - 수동 프로세스

![](https://i.imgur.com/2TYeSPV.png)

##### 특징

- 모델 개발과 배포가 **대부분 수동**으로 이루어짐
	- 각 단계가 개별적으로 수행됨
- 스크립트 기반의 워크플로우가 많고, 반복 작업이 많음
- **모델의 재학습 주기가 매우 긴 경우가 많음** (1년에 두어 번)
	- 하지만 재학습과 업데이트 프로세스가 매우 비효율적임
- 구현 변경사항이 거의 없음 → CI가 필요 없음
- 모델의 변경이 자주 일어나지 않음 → CD가 필요 없음

##### 장단점

- 프로토타이핑에 적합하며, 작은 규모의 프로젝트에서도 도입할만함
- **유지보수가 어려우며 확장성이 떨어짐**
- **재현성이 낮음**
- **협업이 어려움**


#### MLOps Level 1 - ML 파이프라인 자동화

![](https://i.imgur.com/0gO2ndk.png)


##### 특징

- **파이프라인 배포를 제외한 대부분의 단계가 자동화된 ML 파이프라인**
	- 지속적 학습이 파이프라인으로서 자동화되어 있음
		- 실제 세계에서 계속 변하는 데이터로 인해 성능 저하가 발생할 수 있음
		- 성능 저하를 방지하기 위해 지속적인 학습이 필요함
- 지속적 학습 파이프라인은 자동화하였으나 **파이프라인을 배포하는 작업은 수동**으로 진행
- Level 0에 비해 재현성을 확보할 수 있음
- 운영 단계에서 **ML 파이프라인은 새 데이터로 학습한 모델로 예측 서비스를 자동으로 배포**함
	- 지속적 배포 수행
- 지속적 학습을 위해 모니터링 요소를 추가하고 트리거를 통한 재학습을 수행
- 본 강의에서 실습할 수준

#### MLOps Level 2 - CI/CD 파이프라인 자동화

![](https://i.imgur.com/zQlCLCN.png)


- 파이프라인 배포까지 자동화하여 **CI와 CD를 모두 자동화**함
	- 복잡한 아키텍처를 갖게 되지만 운영 단계에서 빠르고 안정적으로 파이프라인을 업데이트할 수 있음
- CI (Continuous Integration)
	- 패키지, 컨테이너 이미지, 실행 파일을 빌드할 수 있음
	- 단위 테스트 등을 자동화할 수 있음
- 모니터링이 강화되어 데이터와 모델의 변화를 감지하고 자동적인 업데이트를 수행할 수 있음
- 본 강의에서 Level 2까지 다루기에는 꽤 많은 툴이 필요하여 Level 1까지만 다룸

### MLOps와 LLMOps의 차이

![](https://i.imgur.com/P0dB8v0.png)


- 가장 큰 차이는 다음과 같음
	- 모델의 개발 주체
		- ML은 사용자가 직접 개발
		- LLM은 일반적으로 사전 학습된 Foundation Model 사용
	- 프롬프트 엔지니어링
		- 프롬프트에 따라 LLM 애플리케이션의 품질이 매우 다름
		- 프롬프트 변화에 대한 버전 관리가 필수
	- 파인튜닝의 역할
		- ML과 LLM에서 의미하는 파인튜닝이 다름
			- ML에서는 모델의 하이퍼파라미터를 **파인튜닝**하여 모델의 성능 향상 도모
				- 파인튜닝을 위한 추가 인프라가 필요 없음
			- LLM에서는 특정 도메인이나 작업에 맞는 답변이 나오도록 **파인튜닝** 수행
				- 파인튜닝을 수행하기 위한 **추가 인프라가 반드시 필요**함
	- 평가 방식
		- 정량적 평가가 매우 어려움
		- 정성적, 질적 평가에 초점

|           | MLOps                                                        | LLMOps                                                       |
| --------- | :------------------------------------------------------------ | :------------------------------------------------------------ |
| 🤖 모델      | - 주로 자체 데이터로 모델을 처음부터 학습 <br>- 피처 엔지니어링이 중요 | - 사전 학습된 Foundation Model을  활용 <br>- 프롬프트 설계 및 관리가 핵심 |
| 🧪 실험 관리 | 하이퍼파라미터, 코드, 데이터셋 버저닝                        | - MLOps의 모든 요소 포함 <br>- 프롬프트, 응답 결과, 파인튜닝 데이터셋 |
| 🖥️ 인프라    | 상대적으로 적은 컴퓨팅 자원                                  | - 직접 모델을 서빙하는 경우 GPU 등 컴퓨팅 자원  필요 <br>- 이에 따른 효율적인 서빙 및 추론 최적화 필요 (vLLM) |
| 📈 모니터링  | 데이터의 분포 변화, 예측값과 실제값의 차이                   | - 성능에 대한 판단이 더 복잡하고 주관적 <br>- 환각(Hallucination), 유해성, 편향성(Bias) 등 정성적이고 질적인 평가 중요 <br> - 사용자의 프롬프트와 모델의 응답에 대한 지속적인 추적 및 분석 수행 |
| 💰 비용      | 모델 학습 및 추론 비용이 거의 들지 않음                      | - 상용 API 사용 시 호출 비용 고려 필요 <br>- 모델이 커질 수록 비용이 일반적으로 증가하여 서빙 비용이 매우 높음 |
| 🤔 고려 요소 | 데이터 파이프라인, 모델 서빙 프레임워크                      | - MLOps의 모든 요소 포함 <br>- 임베딩 관리를 위한 벡터 데이터베이스 <br>- 프롬프트 템플릿 및 체인 관리 |


- LLM은 결정론적(deterministic)인 모델이지만 사용 방법은 확률적(probabilistic)
	- 일반적으로 Temperature / Top-k / Top-p 를 설정하여 사용하기 때문
	- [참고](https://www.linkedin.com/posts/andriyburkov_ok-lets-clarify-this-once-and-for-all-activity-7210120210303852544-IY0C?utm_source=share&utm_medium=member_desktop&rcm=ACoAABwvDBYBEOAR6av-Uv3K2bkP7j62-3ctfQc)



## 1.2 활용 기술 스택 알아보기

### 실습 워크플로우

![](https://i.imgur.com/y3meRG1.png)

- MLOps Level 1 기준

### 활용 기술 스택

- **Docker**
	- 컨테이너 기반의 OS 수준의 가상화 플랫폼
	- 운영 환경과 관련된 모든 요소(DB, 지속적 학습 파이프라인, 예측 서비스)를 **모두 Docker를 이용해 컨테이너로 띄울 예정**
- **mariaDB**
	- 대표적인 오픈소스 RDBMS 중 하나
	- **피처 스토어와 로그 저장소로 활용**하며 Docker를 이용해 띄울 예정
- **GitHub**
	- 소스 코드를 관리하기 위해 사용할 Git 플랫폼
	- 본 실습에선 다루지 않지만 GitHub Actions를 이용한 CI도 가능
- **Apache Airflow**
	- 2014년 에어비엔비에서 개발한 **파이프라인 관리를 위한 오픈소스 워크플로우 관리 플랫폼**
	- 본 실습에서 개발하는 모든 파이프라인은 Airflow로 오케스트레이션
- **MLflow**
	- ML 라이프사이클에서 모델 개발 및 실험 과정을 쉽게 추적할 수 있도록 도와주는 오픈소스 플랫폼
	- 모델 레지스트리와 ML 메타데이터 관리를 위해 사용
- **BentoML**
	- ML 모델을 간단하게 배포하고 관리하기 위한 오픈소스 플랫폼
	- 본 실습에서는 개발한 **모델을 서빙하여 예측 서비스로 띄울 때 FastAPI 대신 사용**

## 1.3 개발 환경 설정

### 저장소 생성

- https://github.com/otzslayer/advanced-mlops 저장소를 Fork하여 사용
	- 참고로 모든 실습 코드는 https://github.com/otzslayer/.lgcns-advanced-mlops 에 있음

### GitHub Codespaces

![](https://i.imgur.com/6QuRrkk.png)

- Fork한 저장소에서 Codespace 생성
	- 4-core / 16GB RAM / 32GB Disk로 설정
	- 위 설정으로 30시간 무료로 사용 가능
- Codespace 생성 후 필요한 익스텐션 설치 진행
	- 추천 익스텐션
		- autoDocstring
		- Better Dockerfile Syntax
		- Git Graph
		- Even Better TOML
		- Path Intellisense
		- Pylance
		- Python
		- Ruff
		- YAML
		- Shell-format
		- Jupyter
		- 원하는 테마


### Docker 설정 필요

- GitHub Codespace 내 Docker 버전에서 발생할 수 있는 버그로 인해 다음 환경 변수 설정

```shell
# 아래 명령어를 실행한 후 ~/.bashrc에 추가
export COMPOSE_BAKE=false
```

### 가상 환경 설정

- Ubuntu apt 저장소 업데이트 및 라이브러리 설치와 설정을 진행

```shell
sudo apt-get update

sudo apt-get install -y make build-essential libssl-dev libreadline-dev wget curl libmysqlclient-dev  
sudo apt-get upgrade -y gcc g++

export CFLAGS=""
export CXXFLAGS=""
```

```shell
sudo rm /etc/localtime
sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
```

![](https://i.imgur.com/kn5B9P8.png)
- `uv` 를 사용하여 가상 환경을 관리함
	- Python 개발 표준인 `pyproject.toml` 파일로 환경 관리
	- 기존에 사용하던 Pipenv, PDM, Poetry 보다 훨씬 빠른 속도로 라이브러리 설치 가능
	- Pyenv 없이 파이썬 버전 관리 가능

- 설치 명령어
```shell
curl -LsSf https://astral.sh/uv/install.sh | sh
```

- 프로젝트 초기화 (파이썬 설치 포함)
```shell
uv init --python 3.12.7
uv venv --python 3.12.7
export PYTHONPATH=/workspaces/advanced-mlops
```

- Python 이 올바르게 설치되었는지 확인
```shell
source .venv/bin/activate
python
```

> [!Tip]
>  다음 에러가 발생하는지 확인 필요
>  ```plain
>  Cannot read termcap database;
>  using dumb terminal settings.
>  ```
>  발생한 경우 `code ~/.bashrc` 명령어 실행하여 해당 파일 맨 마지막에 다음 줄을 추가
>  
>  ```shell
>  export TERMINFO_DIRS=/etc/terminfo:/lib/terminfo:/usr/share/terminfo
>  ```
>  
>  그 이후 터미널에서 `source ~/.bashrc` 명령어로 쉘 재실행

- 불필요한 `main.py` 삭제
```shell
rm main.py
```

- 실습에서 사용할 라이브러리 미리 설치
- Airflow 설치 방식이 조금 까다로움

```shell
# pyproject.toml 내 의존성 관리를 위해 Airflow 우선 설치
uv add apache-airflow==3.0.4

# Airflow 버전 및 Python 버전 설정
export AIRFLOW_VERSION=3.0.4
export PYTHON_VERSION="$(python -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')"

# Constraints 파일 URL 생성
export CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"

# uv를 이용한 Airflow 설치
uv pip install "apache-airflow==${AIRFLOW_VERSION}" --constraint "${CONSTRAINT_URL}"
```

```shell
# 사용할 라이브러리 설치
uv add apache-airflow-providers-mysql==6.3.3 mysqlclient==2.2.7 numpy==2.3.2 pandas==2.3.1 pymysql==1.1.1 scikit-learn==1.7.1 python-dotenv==1.1.1 mlflow==3.2.0 bentoml==1.4.19 catboost==1.2.8 pip==25.2 tqdm==4.67.1 aiomysql==0.2.0 locust==2.39.0

# 개발용 라이브러리(Jupyter 등) 설치
uv add --group jupyter jupyter ipykernel ipython 
```

- 변경된 `pyproject.toml`

```toml
# pyproject.toml

[project]
name = "advanced-mlops"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12.7"
dependencies = [
    "aiomysql==0.2.0",
    "apache-airflow==3.0.4",
    "apache-airflow-providers-mysql==6.3.3",
    "bentoml==1.4.19",
    "catboost==1.2.8",
    "fastapi==0.116.1",
    "locust==2.39.0",
    "mlflow==3.2.0",
    "mysqlclient==2.2.7",
    "numpy==2.3.2",
    "pandas==2.3.1",
    "pip==25.2",
    "pymysql==1.1.1",
    "python-dotenv==1.1.1",
    "scikit-learn==1.7.1",
    "tqdm==4.67.1",
]

[dependency-groups]
jupyter = ["ipykernel>=6.29.5", "ipython>=8.31.0", "jupyter>=1.1.1"]

```
